<!doctype html>
<html>

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>Permissions Adventure</title>
    <link rel="shortcut icon" href="./favicon.ico">
    <!-- CSS  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="./css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
    <link href="./css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  </head>

  <body class="grey lighten-5">
    <nav class="purple" role="navigation">
      <div class="nav-wrapper container">
        <a class="row" style="display: flex; align-items: center" href="/">
          <img
            src="./nav-icon.png"
            class="left"
            style="max-height:50px; margin: 0; margin: 7px 10px 0px 0px"
          />
          <h4 class="left" style="vertical-align: center; margin: 5px 0px 0px 10px">Permissions Adventure</h4>
        </a>
      </div>
    </nav>
    <div class="container section no-pad-bot center">

      <div class="section">
        <div class="row">
          <div class="col l10 card grey lighten-5 left-align">

            <div class="row">
              <h4 style="margin:20px 20px 0px 20px;">
                Status
              </h4>
            </div>

            <div class="row">
              <div class="col l10" style="padding-left:0">
                <h5 id="statusMessage" class="teal-text" style="margin:0px 0px 0px 20px;">
                  Please log in to continue.
                </h5>
              </div>
            </div>

            <div class="row">
              <div class="col l5" style="padding-left:0">
                <h5 class="left" style="margin:20px 20px 0px 20px;">
                  User
                </h5>
              </div>
              <div class="col l6">
                <h5 id="userStatus" class="right-align teal-text" style="margin:20px 0px 0px 20px;">
                  Unknown
                </h5>
              </div>
            </div>

            <div class="row">
              <div class="col l5" style="padding-left:0">
                <h5 class="left" style="margin:20px 20px 0px 20px;">
                  Account
                </h5>
              </div>
              <div class="col l6">
                <h5 id="accountAddress" class="right-align teal-text" style="margin:20px 0px 0px 20px;">
                  Unknown
                </h5>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="col l10 card grey lighten-5 left-align">

            <div class="row">
              <h4 style="margin:20px 20px 0px 20px;">
                Actions
              </h4>
            </div>

            <div class="row">
              <h5 style="margin:20px 20px 0px 20px;">Permission Requests</h5>
            </div>

            <div class="row">
              <button id="enable" class="btn-large waves-effect waves-ligth teal" style="margin:20px 20px 10px 20px;">
                Enable
              </button>
              <button id="allPerms" class="btn-large waves-effect waves-ligth purple" style="margin:20px 20px 10px 20px;">
                Request All
              </button>
              <button id="readWrite" class="btn-large waves-effect waves-ligth purple" style="margin:20px 20px 10px 20px;">
                Read & Write
              </button>
            </div>

            <div class="row">
              <h5 style="margin:20px 20px 0px 20px;">Method Calls</h5>
            </div>

            <div class="row">
              <button id="eth_accounts" class="btn-large waves-effect waves-ligth purple" style="margin:20px 20px 10px 20px;">
                Get Accounts
              </button>
              <button id="read" class="btn-large waves-effect waves-ligth purple" style="margin:20px 20px 10px 20px;">
                Read Profile
              </button>
              <input id="nameInput" style="margin:0px 20px; width: 94%"></input>
              <button id="submitName" class="btn-large waves-effect waves-ligth purple" style="margin:20px 20px 10px 20px;">
                Write to Profile
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="./js/materialize.js"></script>
  <script src="./js/materialize-init.js"></script>
  <script>

    const ethereum = window.ethereum

    /** INIT **/

    window.readProfile = readProfile
    readProfile()
    getAccounts()

    /** LISTENERS **/

    allPerms.addEventListener('click', function() {
      requestPerms({
          readYourProfile: {},
          writeToYourProfile: {},
          eth_accounts: {},
        },
        true,
      )
    })

    readWrite.addEventListener('click', function() {
      requestPerms({
          readYourProfile: {},
          writeToYourProfile: {},
        },
        true,
      )
    })

    enable.addEventListener('click', function() {
      if (!ethereum) throw new Error('no window.ethereum')
      ethereum.send('eth_accounts')
      .then(result => {
        console.dir({ message: 'eth_accounts result', result })
        accountAddress.innerText = getDisplayAddress(result.result[0])
      })
      .catch(error => {
        if (error.code === 1) {
          ethereum.send('eth_requestAccounts')
          .then(result => {
            console.log('ethereum.enable(): ', result)
            accountAddress.innerText = getDisplayAddress(result[0])
          })
          .catch(_error => showError(_error))
        } else {
          showError(error)
        }
      })
    })

    read.addEventListener('click', readProfile)

    eth_accounts.addEventListener('click', () => {
      return getAccounts()
    })

    submitName.addEventListener('click', changeName)

    /** FUNCTIONS **/

    function getAccounts() {
      return ethereum.send('eth_accounts')
      .then(result => {
        console.dir({ message: 'eth_accounts result', result })
        accountAddress.innerText = getDisplayAddress(result[0] || result.result[0])
      })
      .catch(error => {
        showError(error)
        accountAddress.innerText = 'Unknown'
      })
    }

    async function requestPerms (perms, readWhenDone) {
      ethereum.send('wallet_requestPermissions', [perms])
      .then(result => {
        console.dir({ message: 'wallet_requestPermissions result', result })
        for (let perm of result.result) {
          if (perm.parentCapability === 'eth_accounts') {
            accountAddress.innerText = getDisplayAddress(perm.caveats[0].value[0])
          }
        }
        if (readWhenDone) readProfile()
      })
      .catch(error => showError(error))
    }

    function changeName () {
      const name = nameInput.value
      ethereum.send('writeToYourProfile', ['name', name])
      .then(result => {
        console.dir({ message: 'writeToYourProfile result', result })
        readProfile()
      })
      .catch(error => {
        showError(error)
      })
    }

    function readProfile () {
      ethereum.send('readYourProfile', [])
      .then(result => {
        console.dir({ message: 'readYourProfile result', result })
        userStatus.innerText = result.result.name
        statusMessage.innerText = 'Welcome!'
      })
      .catch(error => {
        userStatus.innerText = 'Unknown'
        showError(error)
      })
    }

    function showError (error) {
      statusMessage.innerText = `Had a problem: ${error.message}`
    }

    /**
     * Truncates an Ethereum address for display purposes.
     * @param {string} address the address to truncate
     */
    function getDisplayAddress (address) {
      return address.slice(0, 6) + '...' + address.slice(address.length - 4)
    }
  </script>

</html>
